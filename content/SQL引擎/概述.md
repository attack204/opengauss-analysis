---
# Title, summary, and page position.
title: SQL引擎概述 
linktitle: SQL引擎概述
summary: SQL引擎概述
weight: 1
# icon: book
# icon_pack: fas

# Page metadata.
date: '2022-06-15T00:00:00Z'
type: book # Do not modify.
toc: true
---

# SQL引擎概述

## SQL解析

词法分析：从查询语句中识别出系统支持的关键字、标识符、运算符等

语法分析：根据词法分析的结果，为每个“词”匹配相应的语法规则，并生成相应的抽象树(AST)

语义分析：对语法树进行有效性检查，检查语法树中对应的表、列、函数、表达式是否有对应的元数据，将AST转化为查询计划

![](https://cdn.attack204.com/iShot2022-06-15_12.42.10.png)


## 查询优化

查询优化的技术有

1. RBO(Rule Based Optimizaiton, 基于规则的查询优化)：根据预定义的启发式规则对SQL语句进行优化
2. CBO(Cost Based Optimization, 基于代价的查询优化)：对SQL语句对应的待选执行路径进行代价估算，从待选路径中选择代价最低的执行路径作为最终的执行计划
3. ABO(AI Based Optimization)：根据AI经验对查询进行优化

openGauss采用CBO的方式，同时也在探索ABO模式

### 查询重写

#### 概念

顾名思义就是对查询的语句改变顺序以提高其查询效率

需要遵循的基本原则：等价性与高效性

#### 关系代数式等价变化

根据关系代数式的等价变化，灵活地利用关系代数的等价关系来进行优化推导

1. 借助分配律使操作下推
2. 生成候选的执行计划，再由优化器根据估算的代价进行筛选

#### 常见的查询重写技术

1. 常量表达式化简：例如`SELECT * FROM TABLE where c1=1+1`可以重写成`SELECT * FROM TABLE where c1=2`

2. 子查询优化：按照子查询是否与父查询有关，可以分为`相关子查询`和`非相关子查询`

    a. 对于相关子查询:可以找到其等价的Join，并选择最优的。例如Semi Join技术


    b. 对于非相关子查询：可以先算出子查询的内容并缓存下来。

3. 选择下推和等价推理

这里有张图比较好描述

假设查询语句为`SELECT t1.c1, t2.c1 FROM TB WHERE t1.c1 = t2.c1 AND t1.c1 = 1`

图1:暴力查询，先读出两表的数据做JOIN，然后从tmp表中选择`t1.c1 = t2.c1`的行，再从结果中选择`t1.c1=1`的行

图2:选择下推。先在t1表中选择`t1.c1=1`的行，再做JOIN

图3:等价推理。根据`t1.c1 = t2.c1 AND t1.c1 = 1`可以推出`t2.c1 = 1`，那么可以现在t1表中选择`t1.c1 = 1`的行，并在t2表中选择`t2.c1 = 1`的行，再JOIN

图4：发现查出来的结果一定满足条件，因此不需要JOIN


![](https://cdn.attack204.com/20220615194344.png)

4. 外链接消除

